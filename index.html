<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meme Maker</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="color-options">
      <input type="color" id="color" />
      <div
        class="color-option"
        style="background-color: #1abc9c"
        data-color="#1abc9c"
      ></div>
      <div
        class="color-option"
        style="background-color: #3498db"
        data-color="#3498db"
      ></div>
      <div
        class="color-option"
        style="background-color: #34495e"
        data-color="#34495e"
      ></div>
      <div
        class="color-option"
        style="background-color: #27ae60"
        data-color="#27ae60"
      ></div>
      <div
        class="color-option"
        style="background-color: #8e44ad"
        data-color="#8e44ad"
      ></div>
      <div
        class="color-option"
        style="background-color: #f1c40f"
        data-color="#f1c40f"
      ></div>
      <div
        class="color-option"
        style="background-color: #e74c3c"
        data-color="#e74c3c"
      ></div>
      <div
        class="color-option"
        style="background-color: #95a5a6"
        data-color="#95a5a6"
      ></div>
      <div
        class="color-option"
        style="background-color: #d35400"
        data-color="#d35400"
      ></div>
      <div
        class="color-option"
        style="background-color: #2ecc71"
        data-color="#2ecc71"
      ></div>
      <div
        class="color-option"
        style="background-color: #e67e22"
        data-color="#e67e22"
      ></div>
    </div>
    <canvas></canvas>
    <div class="btns">
      <input
        id="line-width-input"
        type="range"
        min="1"
        max="10"
        value="5"
        step="0.1"
      />
      <button id="mode-btn">ğŸ©¸ Fill</button>
      <button id="destroy-btn">ğŸ’£ Destroy</button>
      <button id="eraser-btn">âŒ Erase</button>
      <label for="file"
        >ğŸ’…ğŸ» Add Photo<input type="file" accept="image/*" id="file"
      /></label>
      <input type="text" id="text" placeholder="Add text here... :)" />
      <button id="save">ğŸ–¼ Save image</button>
      <button id="extract">Extract Image</button>
      <!-- ì´ë¯¸ì§€ ì¶”ì¶œ ë²„íŠ¼ -->
      <button id="undo-btn">â†© Undo</button>
    </div>
    <script>
      const canvas = document.querySelector("canvas");
      const ctx = canvas.getContext("2d");
      const paths = []; // ì‚¬ìš©ìê°€ ê·¸ë¦° ì„ ë“¤ì„ ì €ì¥í•˜ëŠ” ë°°ì—´
      let isExtracting = false; // ì´ë¯¸ì§€ ì¶”ì¶œ ì¤‘ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë³€ìˆ˜

      const CANVAS_WIDTH = 800;
      const CANVAS_HEIGHT = 800;

      canvas.width = CANVAS_WIDTH;
      canvas.height = CANVAS_HEIGHT;
      ctx.lineWidth = 5;
      ctx.lineCap = "round";
      let isPainting = false;
      let isFilling = false;

      function onMove(event) {
        if (isPainting) {
          const x = event.clientX - canvas.getBoundingClientRect().left;
          const y = event.clientY - canvas.getBoundingClientRect().top;
          ctx.lineTo(x, y);
          ctx.stroke();
          paths[paths.length - 1].push({
            x,
            y,
            color: ctx.strokeStyle,
            lineWidth: ctx.lineWidth,
          });
          return;
        }
        const x = event.clientX - canvas.getBoundingClientRect().left;
        const y = event.clientY - canvas.getBoundingClientRect().top;
        ctx.moveTo(x, y);
      }

      function startPainting() {
        isPainting = true;
        paths.push([]);
      }

      function cancelPainting() {
        isPainting = false;
        ctx.beginPath();
      }

      function onLineWidthChange(event) {
        ctx.lineWidth = event.target.value;
      }

      function onColorChange(event) {
        ctx.strokeStyle = event.target.value;
        ctx.fillStyle = event.target.value;
      }

      function onColorClick(event) {
        const colorValue = event.target.dataset.color;
        ctx.strokeStyle = colorValue;
        ctx.fillStyle = colorValue;
        document.getElementById("color").value = colorValue;
      }

      function onModeClick() {
        if (isFilling) {
          isFilling = false;
          document.getElementById("mode-btn").innerText = "Fill";
        } else {
          isFilling = true;
          document.getElementById("mode-btn").innerText = "Draw";
        }
      }

      function onCanvasClick() {
        if (isFilling) {
          ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        }
      }

      function onDestroyClick() {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
      }

      function onEraserClick() {
        ctx.strokeStyle = "white";
        isFilling = false;
        document.getElementById("mode-btn").innerText = "Fill";
      }

      function onFileChange(event) {
        const file = event.target.files[0];
        const url = URL.createObjectURL(file);
        const image = new Image();
        image.src = url;
        image.onload = function () {
          ctx.drawImage(image, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
          document.getElementById("file").value = null;
        };
      }

      function onDoubleClick(event) {
        const text = document.getElementById("text").value;
        if (text !== "") {
          const x = event.clientX - canvas.getBoundingClientRect().left;
          const y = event.clientY - canvas.getBoundingClientRect().top;
          ctx.save();
          ctx.lineWidth = 1;
          ctx.font = "68px sans-serif";
          ctx.fillText(text, x, y);
          ctx.restore();
        }
      }

      function onSaveClick() {
        const url = canvas.toDataURL();
        const a = document.createElement("a");
        a.href = url;
        a.download = "myDrawing.png";
        a.click();
      }

      const extractBtn = document.getElementById("extract");

      function extractImage() {
        if (!isExtracting) {
          isExtracting = true;
          const lastPath = paths[paths.length - 1]; // ìµœê·¼ ê·¸ë¦° ì„ ë“¤
          if (lastPath.length > 0) {
            const extractedCanvas = document.createElement("canvas");
            extractedCanvas.width = CANVAS_WIDTH;
            extractedCanvas.height = CANVAS_HEIGHT;
            const extractedCtx = extractedCanvas.getContext("2d");
            extractedCtx.strokeStyle = ctx.strokeStyle;
            extractedCtx.lineWidth = ctx.lineWidth;
            extractedCtx.lineCap = ctx.lineCap;
            extractedCtx.beginPath();
            extractedCtx.moveTo(lastPath[0].x, lastPath[0].y);
            for (const point of lastPath) {
              extractedCtx.lineTo(point.x, point.y);
            }
            extractedCtx.stroke();
            const url = extractedCanvas.toDataURL(); // ì¶”ì¶œëœ ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸°
            const image = new Image();
            image.src = url;
            const w = window.open(""); // ìƒˆ ì°½ ì—´ê¸°
            w.document.write(image.outerHTML); // ì´ë¯¸ì§€ë¥¼ ìƒˆ ì°½ì— ì“°ê¸°
          }
          isExtracting = false;
        }
      }

      extractBtn.addEventListener("click", extractImage); // ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€

      // undo ê¸°ëŠ¥ì„ ìœ„í•œ í•¨ìˆ˜
      function undo() {
        if (paths.length > 0) {
          paths.pop(); // ë§ˆì§€ë§‰ì— ê·¸ë¦° ì„  ì‚­ì œ
          redraw(); // ê·¸ë¦¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        }
      }

      // ê·¸ë¦¼ì„ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
      function redraw() {
        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

        // ì €ì¥ëœ ì„ ë“¤ì„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        for (const path of paths) {
          ctx.strokeStyle = path[0].color;
          ctx.lineWidth = path[0].lineWidth;
          ctx.beginPath();
          ctx.moveTo(path[0].x, path[0].y);
          for (const point of path) {
            ctx.lineTo(point.x, point.y);
          }
          ctx.stroke();
        }
      }

      const undoBtn = document.getElementById("undo-btn");

      // undo ë²„íŠ¼ í´ë¦­ ì‹œ undo í•¨ìˆ˜ í˜¸ì¶œ
      undoBtn.addEventListener("click", undo);

      canvas.addEventListener("dblclick", onDoubleClick);
      canvas.addEventListener("mousemove", onMove);
      canvas.addEventListener("mousedown", startPainting);
      canvas.addEventListener("mouseup", cancelPainting);
      canvas.addEventListener("mouseleave", cancelPainting);
      canvas.addEventListener("click", onCanvasClick);
      document
        .getElementById("line-width-input")
        .addEventListener("change", onLineWidthChange);
      document
        .getElementById("color")
        .addEventListener("change", onColorChange);
      document
        .querySelectorAll(".color-option")
        .forEach((color) => color.addEventListener("click", onColorClick));
      document
        .getElementById("mode-btn")
        .addEventListener("click", onModeClick);
      document
        .getElementById("destroy-btn")
        .addEventListener("click", onDestroyClick);
      document
        .getElementById("eraser-btn")
        .addEventListener("click", onEraserClick);
      document.getElementById("file").addEventListener("change", onFileChange);
      document.getElementById("save").addEventListener("click", onSaveClick);
    </script>
  </body>
</html>
